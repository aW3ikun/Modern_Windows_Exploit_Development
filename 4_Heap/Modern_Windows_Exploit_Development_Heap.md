This section is refer to [<<Advanced Windows Debugging: Memory Corruption Part II—Heaps>>](https://www.informit.com/articles/article.aspx?p=1081496).

## 0x0 Environment

`Win10 21h2`

run `Windbg Preview` as an administrator

ConsoleApplication1.exe [SHA256:65f7144a2886834adc415129417d6a905e98820918b103ecb8d8ad0765e105f2]

## 0x1 Heap

When a process starts, the **heap manager** creates a new **heap** called the **degfault process heap**. 

C/C++ application also creates the so-called **CRT(C-Runtime) heap**(used by new/delete, malloc/free and their variants).

It is also possible to create  bother heaps via the **HeapCreate** API .

The Windows heap manager can be break down into two components: 

- the **Front End Allocator** 
- the **Back End Allocator** 

​				picture refer to https://www.informit.com/articles/article.aspx?p=1081496

![image-20220106184618301](assets/image-20220106184618301.png)

### 0x11 Front End Allocator

The front end allocator is an abstract optimizations layer for the back end allocator.

#### 0x121 Look aside list (LAL) front end allocator

The LAL is a table of 128 **singly-linked list**（单项链表）.

Each list contains **free blocks** of a specific size, starting at 16bytes.

The size of each block includes 8 bytes of **metadata** used to manage the block.

`index = celi( (size + 8) / 8 ) -1`( ceil(n) 取大于等于数值n的最小整数 )for determining the index into the table given the size.

**Index is always positive**.

If the allocating cannot be satisfied from the LAL, the allocation request now continues its travels and is forwarded to the back end allocator for further processing.

#### 0x122 Low fragmentation (LF) front end allocator

Starting with Windows Vista, `LFH fornt end allocator` instead of `LAL fornt end allocator`. 

LFH front end allocator is very complex.

the main idea is that it tries to reduce the heap fragmentation by allocating the smallest block of memory that is large enough to contain data of the requested size.  (减少内存碎片)

### 0x12 Back End Allocator

If the front end allocator is unable to satisfy an allocation request, the request is sent to the back end
allocator. 

#### 0x121 WinXP

![image-20220107180209913](assets/image-20220107180209913.png)

it uses a table similar to that used in the front end allocator .

**index 0** The list at index 0 of the table contains free blocks whose size is greater than 1016 bytes and less than or equal to the virtual allocation limit (0x7FFF0 bytes).  The blocks in this list are sorted by size in ascending order.  

**index 1** is unused.

index x contains free blocks of size 8x.  

##### 0x1211 Spiltting free blocks

![image-20220107180758992](assets/image-20220107180758992.png)

When a block of a given size is needed but isn’t available, the back end allocator tries to split bigger blocks into blocks of the needed size.  

##### 0x1212 heap coalescing  

when a block is freed, the heap manager checks the two adjacent blocks and if one or both of them are free, the free blocks may be coalesced into a single block. This reduces heap fragmentation.  



For allocations of size greater than 0x7FFF0 bytes the heap manager sends an explicit allocation request to the **virtual memory manager** and keeps the allocated blocks on a list called the **virtual allocation list**.  

#### 0x122 Win7

Windows 7 uses a single free list which holds blocks of all sizes sorted by size in ascending order  .

another list of nodes (of type ListHint) which point to nodes in the free list and are used to find the nodes of the appropriate size to satisfy the allocation request.  

### 0x13 Heap segment

All the memory used by the **heap manager** is requested from the **Windows virtual memory manager**. 

Heap manager requests **big chunks of virtual memory** called **segments**. 

When a **new segment** is created, its memory is just reserved and only a small portion of it is committed. 

When more memory is needed, another portion is committed. 

Finally, when there **isn’t enough uncommitted** space in the current segment, a new segment is created which is **twice as big as** the previous segment. 

If this isn’t possible because there **isn’t enough memory**, a **smaller** segment is created. If the available space is **insufficient** even for the **smallest** possible segment, an **error** is returned.  

### 0x14 Analyzing the Heap

Open `ConsoleApplication1.exe` in windbg.

Then input "g" on the command prompt.

breakpoint at offset 0x1019.

![image-20220111155444515](assets/image-20220111155444515.png)

The list of heaps is contained in the PEB (Process Environment Block ) at offset 0x90:

```c
0:000> dt _PEB @$peb
ntdll!_PEB
   +0x000 InheritedAddressSpace : 0 ''
   +0x001 ReadImageFileExecOptions : 0 ''
   +0x002 BeingDebugged    : 0x1 ''
   +0x003 BitField         : 0x4 ''
   +0x003 ImageUsesLargePages : 0y0
   +0x003 IsProtectedProcess : 0y0
   +0x003 IsImageDynamicallyRelocated : 0y1
   +0x003 SkipPatchingUser32Forwarders : 0y0
   +0x003 IsPackagedProcess : 0y0
   +0x003 IsAppContainer   : 0y0
   +0x003 IsProtectedProcessLight : 0y0
   +0x003 IsLongPathAwareProcess : 0y0
   +0x004 Mutant           : 0xffffffff Void
   +0x008 ImageBaseAddress : 0x00d90000 Void
   +0x00c Ldr              : 0x777a5d80 _PEB_LDR_DATA
   +0x010 ProcessParameters : 0x00742480 _RTL_USER_PROCESS_PARAMETERS
   +0x014 SubSystemData    : (null) 
   +0x018 ProcessHeap      : 0x00740000 Void
   +0x01c FastPebLock      : 0x777a5b40 _RTL_CRITICAL_SECTION
   +0x020 AtlThunkSListPtr : (null) 
   +0x024 IFEOKey          : (null) 
   +0x028 CrossProcessFlags : 0
   +0x028 ProcessInJob     : 0y0
   +0x028 ProcessInitializing : 0y0
   +0x028 ProcessUsingVEH  : 0y0
   +0x028 ProcessUsingVCH  : 0y0
   +0x028 ProcessUsingFTH  : 0y0
   +0x028 ProcessPreviouslyThrottled : 0y0
   +0x028 ProcessCurrentlyThrottled : 0y0
   +0x028 ProcessImagesHotPatched : 0y0
   +0x028 ReservedBits0    : 0y000000000000000000000000 (0)
   +0x02c KernelCallbackTable : (null) 
   +0x02c UserSharedInfoPtr : (null) 
   +0x030 SystemReserved   : 0
   +0x034 AtlThunkSListPtr32 : (null) 
   +0x038 ApiSetMap        : 0x001b0000 Void
   +0x03c TlsExpansionCounter : 0
   +0x040 TlsBitmap        : 0x777a5d30 Void
   +0x044 TlsBitmapBits    : [2] 0x10001
   +0x04c ReadOnlySharedMemoryBase : 0x7f210000 Void
   +0x050 SharedData       : (null) 
   +0x054 ReadOnlyStaticServerData : 0x7f210750  -> (null) 
   +0x058 AnsiCodePageData : 0x7f370000 Void
   +0x05c OemCodePageData  : 0x7f370000 Void
   +0x060 UnicodeCaseTableData : 0x7f3a0028 Void
   +0x064 NumberOfProcessors : 0xc
   +0x068 NtGlobalFlag     : 0x70
   +0x070 CriticalSectionTimeout : _LARGE_INTEGER 0xffffe86d`079b8000
   +0x078 HeapSegmentReserve : 0x100000
   +0x07c HeapSegmentCommit : 0x2000
   +0x080 HeapDeCommitTotalFreeThreshold : 0x10000
   +0x084 HeapDeCommitFreeBlockThreshold : 0x1000
   +0x088 NumberOfHeaps    : 2
   +0x08c MaximumNumberOfHeaps : 0x10
   +0x090 ProcessHeaps     : 0x777a4840  -> 0x00740000 Void
   +0x094 GdiSharedHandleTable : (null) 
   +0x098 ProcessStarterHelper : (null) 
   +0x09c GdiDCAttributeList : 0
   +0x0a0 LoaderLock       : 0x777a3390 _RTL_CRITICAL_SECTION
   +0x0a4 OSMajorVersion   : 0xa
   +0x0a8 OSMinorVersion   : 0
   +0x0ac OSBuildNumber    : 0x4a64
   +0x0ae OSCSDVersion     : 0
   +0x0b0 OSPlatformId     : 2
   +0x0b4 ImageSubsystem   : 3
   +0x0b8 ImageSubsystemMajorVersion : 6
   +0x0bc ImageSubsystemMinorVersion : 0
   +0x0c0 ActiveProcessAffinityMask : 0xfff
   +0x0c4 GdiHandleBuffer  : [34] 0
   +0x14c PostProcessInitRoutine : (null) 
   +0x150 TlsExpansionBitmap : 0x777a5d18 Void
   +0x154 TlsExpansionBitmapBits : [32] 1
   +0x1d4 SessionId        : 1
   +0x1d8 AppCompatFlags   : _ULARGE_INTEGER 0x0
   +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER 0x0
   +0x1e8 pShimData        : 0x001f0000 Void
   +0x1ec AppCompatInfo    : (null) 
   +0x1f0 CSDVersion       : _UNICODE_STRING ""
   +0x1f8 ActivationContextData : 0x001e0000 _ACTIVATION_CONTEXT_DATA
   +0x1fc ProcessAssemblyStorageMap : (null) 
   +0x200 SystemDefaultActivationContextData : 0x001d0000 _ACTIVATION_CONTEXT_DATA
   +0x204 SystemAssemblyStorageMap : (null) 
   +0x208 MinimumStackCommit : 0
   +0x20c SparePointers    : [4] (null) 
   +0x21c SpareUlongs      : [5] 0
   +0x230 WerRegistrationData : (null) 
   +0x234 WerShipAssertPtr : (null) 
   +0x238 pUnused          : (null) 
   +0x23c pImageHeaderHash : (null) 
   +0x240 TracingFlags     : 0
   +0x240 HeapTracingEnabled : 0y0
   +0x240 CritSecTracingEnabled : 0y0
   +0x240 LibLoaderTracingEnabled : 0y0
   +0x240 SpareTracingBits : 0y00000000000000000000000000000 (0)
   +0x248 CsrServerReadOnlySharedMemoryBase : 0x00007df4`f0d60000
   +0x250 TppWorkerpListLock : 0
   +0x254 TppWorkerpList   : _LIST_ENTRY [ 0x93fa2c - 0xb3fab4 ]
   +0x25c WaitOnAddressHashTable : [128] (null) 
   +0x45c TelemetryCoverageHeader : (null) 
   +0x460 CloudFileFlags   : 0x62
   +0x464 CloudFileDiagFlags : 0
   +0x468 PlaceholderCompatibilityMode : 1 ''
   +0x469 PlaceholderCompatibilityModeReserved : [7]  ""
   +0x470 LeapSecondData   : 0x7f360000 _LEAP_SECOND_DATA
   +0x474 LeapSecondFlags  : 0
   +0x474 SixtySecondEnabled : 0y0
   +0x474 Reserved         : 0y0000000000000000000000000000000 (0)
   +0x478 NtGlobalFlag2    : 0
```

The instersting part is this:

```c
0:000> dt _PEB @$peb NumberOfHeaps ProcessHeaps
ntdll!_PEB
   +0x088 NumberOfHeaps : 2
   +0x090 ProcessHeaps  : 0x777a4840  -> 0x00740000 Void
```

`ProcessHeaps` points to an array of pointers to `HEAP` structures (one pointer per heap).

```assembly
0:000> dd 0x777a4840
777a4840  00740000 00c60000 00000000 00000000
777a4850  00000000 00000000 00000000 00000000
777a4860  00000000 00000000 00000000 00000000
777a4870  00000000 00000000 00000000 00000000
```

The display the `HEAP` structure of the first heap like this:

```c
0:000> dt _HEAP 00740000
ntdll!_HEAP
   +0x000 Segment          : _HEAP_SEGMENT
   +0x000 Entry            : _HEAP_ENTRY
   +0x008 SegmentSignature : 0xffeeffee
   +0x00c SegmentFlags     : 2
   +0x010 SegmentListEntry : _LIST_ENTRY [ 0x7400a4 - 0x7400a4 ]
   +0x018 Heap             : 0x00740000 _HEAP
   +0x01c BaseAddress      : 0x00740000 Void
   +0x020 NumberOfPages    : 0xff
   +0x024 FirstEntry       : 0x007404a8 _HEAP_ENTRY
   +0x028 LastValidEntry   : 0x0083f000 _HEAP_ENTRY
   +0x02c NumberOfUnCommittedPages : 0xf4
   +0x030 NumberOfUnCommittedRanges : 1
   +0x034 SegmentAllocatorBackTraceIndex : 0
   +0x036 Reserved         : 0
   +0x038 UCRSegmentList   : _LIST_ENTRY [ 0x74aff0 - 0x74aff0 ]
   +0x040 Flags            : 0x40000062
   +0x044 ForceFlags       : 0x40000060
   +0x048 CompatibilityFlags : 0x20000000
   +0x04c EncodeFlagMask   : 0x100000
   +0x050 Encoding         : _HEAP_ENTRY
   +0x058 Interceptor      : 0
   +0x05c VirtualMemoryThreshold : 0xfe00
   +0x060 Signature        : 0xeeffeeff
   +0x064 SegmentReserve   : 0x100000
   +0x068 SegmentCommit    : 0x2000
   +0x06c DeCommitFreeBlockThreshold : 0x200
   +0x070 DeCommitTotalFreeThreshold : 0x2000
   +0x074 TotalFreeSize    : 0xe5
   +0x078 MaximumAllocationSize : 0x7ffdefff
   +0x07c ProcessHeapsListIndex : 1
   +0x07e HeaderValidateLength : 0x258
   +0x080 HeaderValidateCopy : (null) 
   +0x084 NextAvailableTagIndex : 0
   +0x086 MaximumTagIndex  : 0
   +0x088 TagEntries       : (null) 
   +0x08c UCRList          : _LIST_ENTRY [ 0x74afe8 - 0x74afe8 ]
   +0x094 AlignRound       : 0x17
   +0x098 AlignMask        : 0xfffffff8
   +0x09c VirtualAllocdBlocks : _LIST_ENTRY [ 0x74009c - 0x74009c ]
   +0x0a4 SegmentList      : _LIST_ENTRY [ 0x740010 - 0x740010 ]
   +0x0ac AllocatorBackTraceIndex : 0
   +0x0b0 NonDedicatedListLength : 0
   +0x0b4 BlocksIndex      : 0x00740270 Void
   +0x0b8 UCRIndex         : (null) 
   +0x0bc PseudoTagEntries : (null) 
   +0x0c0 FreeLists        : _LIST_ENTRY [ 0x7458e0 - 0x74aa30 ]
   +0x0c8 LockVariable     : 0x00740258 _HEAP_LOCK
   +0x0cc CommitRoutine    : 0xf58e9a23     long  +fffffffff58e9a23
   +0x0d0 StackTraceInitVar : _RTL_RUN_ONCE
   +0x0d4 CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA
   +0x0e4 FrontEndHeap     : (null) 
   +0x0e8 FrontHeapLockCount : 0
   +0x0ea FrontEndHeapType : 0 ''
   +0x0eb RequestedFrontEndHeapType : 0 ''
   +0x0ec FrontEndHeapUsageData : 0x007404b0  ""
   +0x0f0 FrontEndHeapMaximumIndex : 0x80
   +0x0f2 FrontEndHeapStatusBitmap : [257]  ""
   +0x1f4 Counters         : _HEAP_COUNTERS
   +0x250 TuningParameters : _HEAP_TUNING_PARAMETERS
```

#### 0x141 Using Mona

##### 0x1411 heap

```c
0:000> !py d:\dbgext\mona heap
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9

Please specify a valid searchtype -t
Valid values are :
   lal
   lfh
   all
   segments
   chunks
   layout
   fea
   bea

[+] This mona.py action took 0:00:00.050000
```

As we can see there are 2 heaps and mona also shows the segments for each heap.

##### 0x1412 -h 0x0000 -t segments

```c
0:000> !py d:\dbgext\mona heap -h 0x00740000 -t segments
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap -h 0x00740000 -t segments
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9


[+] Processing heap 0x00740000
Segment List for heap 0x00740000:
---------------------------------
Segment 0x007404a8 - 0x0083f000 (FirstEntry: 0x007404a8 - LastValidEntry: 0x0083f000): 0x000feb58 bytes

[+] This mona.py action took 0:00:00.008000
```

Note that  `mona` shows a summary of all the heaps followed by specific information we asker. 

we can alse omit "-h 0x00740000" to get a list of the segments of **all the heaps**:

```c
0:000> !py d:\dbgext\mona heap -t segments
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap -t segments
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9


[+] Processing heap 0x00740000
Segment List for heap 0x00740000:
---------------------------------
Segment 0x007404a8 - 0x0083f000 (FirstEntry: 0x007404a8 - LastValidEntry: 0x0083f000): 0x000feb58 bytes

[+] Processing heap 0x00c60000
Segment List for heap 0x00c60000:
---------------------------------
Segment 0x00c604a8 - 0x00c90000 (FirstEntry: 0x00c604a8 - LastValidEntry: 0x00c90000): 0x0002fb58 bytes

[+] This mona.py action took 0:00:00.011000
```

`mona.py` calls the allocated block of memory chunks.

To see the chunks in the segmentss for a heap use:

```c
0:000> !py d:\dbgext\mona heap -h 740000 -t chunks
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap -h 740000 -t chunks
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9

[+] Preparing output file 'heapchunks.txt'
    - Creating working folder d:\temp\mona_files\ConsoleApplication1_23664
    - Folder created
    - (Re)setting logfile d:\temp\mona_files\ConsoleApplication1_23664\heapchunks.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.

[+] Processing heap 0x00740000
Segment List for heap 0x00740000:
---------------------------------
Segment 0x007404a8 - 0x0083f000 (FirstEntry: 0x007404a8 - LastValidEntry: 0x0083f000): 0x000feb58 bytes
    Nr of chunks : 130 
    _HEAP_ENTRY  psize   size  unused  UserPtr   UserSize
       007404a8  00000  00118   00001  007404c8  00000117 (279) (Internal,Fill pattern,Extra present,Busy (LFH)) 
       007405c0  00118  000e8   00018  007405c8  000000d0 (208) (Fill pattern,Extra present,Busy) 
       007406a8  000e8  00140   00018  007406b0  00000128 (296) (Fill pattern,Extra present,Busy) 
       007407e8  00140  00138   00018  007407f0  00000120 (288) (Fill pattern,Extra present,Busy) 
       00740920  00138  00040   0001c  00740928  00000024 (36) (Fill pattern,Extra present,Busy) 
       00740960  00040  00020   0001c  00740968  00000004 (4) (Fill pattern,Extra present,Busy) 
       00740980  00020  00028   0001c  00740988  0000000c (12) (Fill pattern,Extra present,Busy) 
       007409a8  00028  000e8   00018  007409b0  000000d0 (208) (Fill pattern,Extra present,Busy) 
<snip>
       0074afb8  00590  00028   0001b  0074afc0  0000000d (13) (Fill pattern,Extra present,Busy) 
       0074afe0  00028  00020   00003  0074afe8  0000001d (29) (Busy) 
       0x0074aff8 - 0x0083f000 (end of segment) : 0xf4008 (999432) uncommitted bytes

Heap : 0x00740000 : VirtualAllocdBlocks : 0 
    Nr of chunks : 0 

[+] This mona.py action took 0:00:04.535000

```

To display some statistics(统计), add the option "-stat".

##### 0x1413 -stat

```c
0:000> !py d:\dbgext\mona heap -h 740000 -t chunks -stat
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap -h 740000 -t chunks -stat
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9

[+] Preparing output file 'heapchunks.txt'
    - (Re)setting logfile d:\temp\mona_files\ConsoleApplication1_23664\heapchunks.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.

[+] Processing heap 0x00740000
Segment List for heap 0x00740000:
---------------------------------
Segment 0x007404a8 - 0x0083f000 (FirstEntry: 0x007404a8 - LastValidEntry: 0x0083f000): 0x000feb58 bytes
    Nr of chunks : 130 
    _HEAP_ENTRY  psize   size  unused  UserPtr   UserSize
    Segment Statistics:
    Size : 0x2000 (8192) : 1 chunks (0.77 %)
    Size : 0x18e8 (6376) : 1 chunks (0.77 %)
    Size : 0xe00 (3584) : 1 chunks (0.77 %)
    Size : 0xa6e (2670) : 1 chunks (0.77 %)
    Size : 0x800 (2048) : 1 chunks (0.77 %)
    Size : 0x6c8 (1736) : 1 chunks (0.77 %)
    Size : 0x590 (1424) : 1 chunks (0.77 %)
    Size : 0x49c (1180) : 1 chunks (0.77 %)
.....
```

##### 0x1414 -t layout

`mona.py` is able to discover **strings**, **BSTRINGs** and **vtable objects** in the *blocks/chunks* of the segments.

Use `-t layout`.This function writes the data to the file heaplayout.txt.

You can use the following additionnal options

| Expressions    | Description                                                  |
| -------------- | ------------------------------------------------------------ |
| -v             | write the data also in the log window                        |
| -fast          | skip the discovery of object sizes                           |
| -size \<sz>    | skip strings that are smaller than \<sz\>                    |
| -after \<val\> | ignore entries inside a chunk until either a string or vtable reference is found that contains the value \<val\>; then, output everything for the current chunk. |

Example:

```c
0:000> !py d:\dbgext\mona heap -h 740000 -t layout -v
*******************************************************************************************
Hold on...
[+] Command used:
!py d:\dbgext\mona.py heap -h 740000 -t layout -v
Peb : 0x00320000, NtGlobalFlag : 0x00000070
Heaps:
------
0x00740000 (1 segment(s) : 0x00740000) * Default process heap  Encoding key: 0x28bafae9
0x00c60000 (1 segment(s) : 0x00c60000)   Encoding key: 0x9fd7bec9

[+] Preparing output file 'heaplayout.txt'
    - (Re)setting logfile d:\temp\mona_files\ConsoleApplication1_23664\heaplayout.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.

[+] Processing heap 0x00740000
----- Heap 0x00740000, Segment 0x007404a8 - 0x0083f000 (1/1) -----
Chunk 0x007404a8 (Usersize 0x117, ChunkSize 0x118) : Virtallocd,Fill pattern,Extra present,Busy
Chunk 0x007405c0 (Usersize 0xd0, ChunkSize 0xe8) : Fill pattern,Extra present,Busy
Chunk 0x007406a8 (Usersize 0x128, ChunkSize 0x140) : Fill pattern,Extra present,Busy
Chunk 0x007407e8 (Usersize 0x120, ChunkSize 0x138) : Fill pattern,Extra present,Busy
Chunk 0x00740920 (Usersize 0x24, ChunkSize 0x40) : Fill pattern,Extra present,Busy
Chunk 0x00740960 (Usersize 0x4, ChunkSize 0x20) : Fill pattern,Extra present,Busy
Chunk 0x00740980 (Usersize 0xc, ChunkSize 0x28) : Fill pattern,Extra present,Busy
Chunk 0x007409a8 (Usersize 0xd0, ChunkSize 0xe8) : Fill pattern,Extra present,Busy
Chunk 0x00740a90 (Usersize 0xd0, ChunkSize 0xe8) : Fill pattern,Extra present,Busy
Chunk 0x00740b78 (Usersize 0x18e8, ChunkSize 0x1900) : Fill pattern,Extra present,Busy
  +02f3 @ 00740e6b->00740f6d : Unicode (0x100/256 bytes, 0x80/128 chars) : DBGENG_OVERRIDE_DBGSRV_PATH=C:\Users\Users\AppData\Local\Microsoft\WindowsApps\Microsoft.WinDb...
  +00aa @ 00741017->0074109f : Unicode (0x86/134 bytes, 0x43/67 chars) : DXSDK_DIR=C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\
  +01ee @ 0074128d->00741315 : Unicode (0x86/134 bytes, 0x43/67 chars) : MOZ_PLUGIN_PATH=D:\Daily_tools\pdf_reader\Foxit PDF Reader\plugins\
  +00b0 @ 007413c5->00741cfd : Unicode (0x936/2358 bytes, 0x49b/1179 chars) : Path=C:\Program Files\WindowsApps\Microsoft.WinDbg_1.2111.9001.0_neutral__8wekyb3d8bbwe\x86;C:\Progr...
  +0160 @ 00741e5d->00741ef1 : Unicode (0x92/146 bytes, 0x49/73 chars) : PROCESSOR_IDENTIFIER=Intel64 Family 6 Model 158 Stepping 10, GenuineIntel
  +0160 @ 00742051->00742127 : Unicode (0xd4/212 bytes, 0x6a/106 chars) : PSModulePath=C:\Program Files\WindowsPowerShell\Modules;C:\WINDOWS\system32\WindowsPowerShell\v1.0\M...
  +026e @ 00742395->00742425 : Unicode (0x8e/142 bytes, 0x47/71 chars) : _NT_SYMBOL_PATH=SRV*d:\\pdb*https://msdl.microsoft.com/download/symbols
Chunk 0x00742478 (Usersize 0x2000, ChunkSize 0x2018) : Fill pattern,Extra present,Busy
  +04cf @ 00742947->00742a01 : Unicode (0xb8/184 bytes, 0x5c/92 chars) : D:\OneDrive\Modern_Windows_Exploit_Development\4_Heap\ConsoleApplication1.exe
  +0000 @ 00742a01->00742abb : Unicode (0xb8/184 bytes, 0x5c/92 chars) : D:\OneDrive\Modern_Windows_Exploit_Development\4_Heap\ConsoleApplication1.exe
  +0000 @ 00742abb->00742b75 : Unicode (0xb8/184 bytes, 0x5c/92 chars) : D:\OneDrive\Modern_Windows_Exploit_Development\4_Heap\ConsoleApplication1.exe
  +030e @ 00742e83->00742f85 : Unicode (0x100/256 bytes, 0x80/128 chars) : DBGENG_OVERRIDE_DBGSRV_PATH=C:\Users\Users\AppData\Local\Microsoft\WindowsApps\Microsoft.WinDb...
  +00aa @ 0074302f->007430b7 : Unicode (0x86/134 bytes, 0x43/67 chars) : DXSDK_DIR=C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\
  +01ee @ 007432a5->0074332d : Unicode (0x86/134 bytes, 0x43/67 chars) : MOZ_PLUGIN_PATH=D:\Daily_tools\pdf_reader\Foxit PDF Reader\plugins\
  +00b0 @ 007433dd->00743d15 : Unicode (0x936/2358 bytes, 0x49b/1179 chars) : Path=C:\Program Files\WindowsApps\Microsoft.WinDbg_1.2111.9001.0_neutral__8wekyb3d8bbwe\x86;C:\Progr...
  +0160 @ 00743e75->00743f09 : Unicode (0x92/146 bytes, 0x49/73 chars) : PROCESSOR_IDENTIFIER=Intel64 Family 6 Model 158 Stepping 10, GenuineIntel
  +0160 @ 00744069->0074413f : Unicode (0xd4/212 bytes, 0x6a/106 chars) : PSModulePath=C:\Program Files\WindowsPowerShell\Modules;C:\WINDOWS\system32\WindowsPowerShell\v1.0\M...
  +026e @ 007443ad->0074443d : Unicode (0x8e/142 bytes, 0x47/71 chars) : _NT_SYMBOL_PATH=SRV*d:\\pdb*https://msdl.microsoft.com/download/symbols
Chunk 0x00744490 (Usersize 0x3c, ChunkSize 0x58) : Fill pattern,Extra present,Busy
Chunk 0x007444e8 (Usersize 0x30, ChunkSize 0x48) : Fill pattern,Extra present,Busy
Chunk 0x00744530 (Usersize 0x62, ChunkSize 0x80) : Fill pattern,Extra present,Busy
Chunk 0x007445b0 (Usersize 0xa8, ChunkSize 0xc0) : Fill pattern,Extra present,Busy
<snip>
  +001b @ 0074a5eb->0074a6cf : Unicode (0xe2/226 bytes, 0x71/113 chars) : \Device\HarddiskVolume1\OneDrive\Modern_Windows_Exploit_Development\4_Heap\ConsoleApp...
Chunk 0x0074aa28 (Usersize 0x590, ChunkSize 0x590) : Fill pattern
Chunk 0x0074afb8 (Usersize 0xd, ChunkSize 0x28) : Fill pattern,Extra present,Busy
Chunk 0x0074afe0 (Usersize 0x1d, ChunkSize 0x20) : Busy

[+] This mona.py action took 0:00:05.062000
```

Consider the following two lines extracted from the output above:

```c
Chunk 0x00740b78 (Usersize 0x18e8, ChunkSize 0x1900) : Fill pattern,Extra present,Busy
  +02f3 @ 00740e6b->00740f6d : Unicode (0x100/256 bytes, 0x80/128 chars) : DBGENG_OVERRIDE_DBGSRV_PATH=C:\Users\Users\AppData\Local\Microsoft\WindowsApps\Microsoft.WinDb...
```

The seconed lines tells us that:

1. the entry is at 0x2f3 bytes from the beginning of the chunk;
2. the entry is from 00740e6b to 00740f6d;
3. the entry is a `Unicode string` of 256 bytes or 128 chars;
4. the strings is "DBGENG_OVERRIDE_DBGSRV_PATH=C:\Users\Users\AppData\\...."

#### 0x142 `!heap`

##### 0x1421 -m

We also use !heap:

```c
0:000> !heap -m
Index   Address  Name      Debugging options enabled
  1:   00740000 
    Segment at 00740000 to 0083f000 (0000b000 bytes committed)
  2:   00c60000 
    Segment at 00c60000 to 00c90000 (00020000 bytes committed)
```

The option "-m" shows also the segments.

##### 0x1422 -h 0x0000

To see the chunks in the segments for a heap use:

```c
0:000> !heap -h 740000
Index   Address  Name      Debugging options enabled
  1:   00740000 
    Segment at 00740000 to 0083f000 (0000b000 bytes committed)
    Flags:                40000062
    ForceFlags:           40000060
    Granularity:          8 bytes
    Segment Reserve:      00100000
    Segment Commit:       00002000
    DeCommit Block Thres: 00000200
    DeCommit Total Thres: 00002000
    Total Free Size:      000000e5
    Max. Allocation Size: 7ffdefff
    Lock Variable at:     00740258
    Next TagIndex:        0000
    Maximum TagIndex:     0000
    Tag Entries:          00000000
    PsuedoTag Entries:    00000000
    Virtual Alloc List:   0074009c
    Uncommitted ranges:   0074008c
    FreeList[ 00 ] at 007400c0: 0074aa30 . 007458e0   (8 blocks)

    Heap entries for Segment00 in Heap 00740000
         address: psize . size  flags   state (requested size)
        00740000: 00000 . 004a8 [101] - busy (4a7)
        007404a8: 004a8 . 00118 [107] - busy (117), tail fill Internal 
        007405c0: 00118 . 000e8 [107] - busy (d0), tail fill
        007406a8: 000e8 . 00140 [107] - busy (128), tail fill
        007407e8: 00140 . 00138 [107] - busy (120), tail fill
        00740920: 00138 . 00040 [107] - busy (24), tail fill
<snip>
        00749c88: 00060 . 00038 [107] - busy (20), tail fill
        00749cc0: 00038 . 00818 [107] - busy (800), tail fill
        0074a4d8: 00818 . 000f8 [107] - busy (e0), tail fill
        0074a5d0: 000f8 . 00458 [107] - busy (440), tail fill
        0074aa28: 00458 . 00590 [104] free fill
        0074afb8: 00590 . 00028 [107] - busy (d), tail fill
        0074afe0: 00028 . 00020 [111] - busy (1d)
        0074b000:      000f4000      - uncommitted bytes.
```

### 0x15 Summary

|                 |                            |
| --------------- | -------------------------- |
| dt _PEB @$peb   | Display PEB                |
| dt _HEAP 2d0000 | display the HEAP structure |



#### 0x151 Mona

`!py d:\dbgext\mona help heap`

| Expression      | Description                                                  |
| --------------- | ------------------------------------------------------------ |
| heap            | Show information about various heap chunk lists              |
| -h \<address\>  | base address of the heap to query                            |
| -t \<type\>     | where type is 'segments', 'chunks', 'layout'                 |
| -stat           | show statistics (also works in combination with -h heap, -t segments or -t chunks |
| -size \<nr\>    | only show strings of at least the specified size. Works in combination with 'layout' |
| -after \<data\> | only show current & next chunk layout entries when an entry contains this data                     (Only works in combination with 'layout') |
| -v              | show data / write verbose info to the Log window             |

#### !heap

| Expression        | Description                                   |
| ----------------- | --------------------------------------------- |
| !heap -m          | shows the segments for each heap              |
| !heap -h \<addr\> | see the chunks in the segments for a heap use |

