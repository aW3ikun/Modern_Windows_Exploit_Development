## 0x0 Environment

`Win10 21h2`

run `Windbg Preview` as an administrator

Mona

## 0x1 SEH

`Structed Exception Handling`

The exception handlers are organized in a `singly-linked list` associated with

**each thread**.

The head of the the list is pointer located at the beginning of the `TEB(Thread Environment Block)`,so when the code wants to add a new exception handler, a new node is added to the head of the list and the pointer in the TEB is changer to point to the new node.

Each node is of type `_EXCEPTION_REGISTRATION_RECORD` and store the address of the handler and a pointer to the next node of the list.

```c
0:000> dt _EXCEPTION_REGISTRATION_RECORD
ConsoleApplication1!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : Ptr32 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : Ptr32     _EXCEPTION_DISPOSITION 
```

the `"Next pointer"` of the last node of the list is not null but equal to 0xffffffff.

The TEB can also be accessed through the **selector** `fs`, starting from `fs:[0]`.

### 0x11 Assembly (x86)

```x86asm
mov eax,dword ptr fs:[00000000h] ;retrive the head
push eax			; save the old head
lea	eax,[ebp-10h]	 ;get the new head
mov dword ptr fs:[00000000h],eax ; set the new head
.
.
.
mov	ecx,dword ptr [ebp-10h]	; get the old head (Next field of the current head)
mov dowrd ptr fs:[00000000g],ecx	; restore the old head
```

In fact ,code like the following:

```x86asm
# install seh handler
push offset SEHandler
push fs:[0]
mov fs:[0],esp
```

```x86asm
# uninstall seh handler
pop dword ptr fs:[0]
```

![image-20211222161426923](assets/image-20211222161426923.png)

### 0x12 Compilers behaviour

Compilers usually register a single `global handler` that knows which area of the program is being executed(relying on a global variable )and behaves according when it's called.

each thread has a different TEB. the operating system makes sure that the segment selected by fs refers always to the right TEB. 

To get the address of the TEB, read fs:[18h] which corresponds to the field Self of the TEB.

### 0x13 Check ExceptionList

relationship of TIB and TEB.

```c++
0:000> dt nt!_teb
ntdll!_TEB
   +0x000 NtTib            : _NT_TIB
   +0x01c EnvironmentPointer : Ptr32 Void
   +0x020 ClientId         : _CLIENT_ID
   +0x028 ActiveRpcHandle  : Ptr32 Void
   +0x02c ThreadLocalStoragePointer : Ptr32 Void
   +0x030 ProcessEnvironmentBlock : Ptr32 _PEB
       .....
```

Display the TEB:

```c
0:000> !teb
TEB at 00682000
    ExceptionList:        0093fd8c
    StackBase:            00940000
    StackLimit:           0093d000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00682000
    EnvironmentPointer:   00000000
    ClientId:             0000477c . 000049e8
    RpcHandle:            00000000
    Tls Storage:          0068202c
    PEB Address:          0067f000
    LastErrorValue:       0
    LastStatusValue:      0
    Count Owned Locks:    0
    HardErrorMode:        0
```

Let's verify that `fs` refers to the `TEB`:

```c
0:000> dg fs
                                  P Si Gr Pr Lo
Sel    Base     Limit     Type    l ze an es ng Flags
---- -------- -------- ---------- - -- -- -- -- --------
0053 00682000 00000fff Data RW Ac 3 Bg By P  Nl 000004f3
```

fs:18h contains the address of the TEB.

`poi` dereferences a pointer .

`?` is used to evaluate an expression.

```c
0:000> ? poi(fs:[18])
Evaluate expression: 6823936 = 00682000 <------TEB address
```

Let's see what's the name of the structre pointed to by ExceptionList above:

```c
0:000> dt nt!_nt_tib exceptionlist
ntdll!_NT_TIB
   +0x000 ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD
```

Each node is an instance of `_EXCEPTION_REGISTRATION_RECORD`.

To display the entire list ,use `!slist`.(The **!slist** extension displays a singly-linked list (SList).)

```c
0:000> !slist $teb _EXCEPTION_REGISTRATION_RECORD
SLIST HEADER:
   +0x000 Alignment          : 9400000093fd8c
   +0x000 Next               : 93fd8c
   +0x004 Depth              : 0
   +0x000 Sequence           : 0

SLIST CONTENTS:
0093fd8c
   +0x000 Next             : 0x0093fda4 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x777bad40     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0
0093fda4
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x777c8a39     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad9+0
ffffffff
   +0x000 Next             : ???? 
   +0x004 Handler          : ???? 
Can't read memory at ffffffff, error 0
```

`$teb` is the address of the TEB.

#### 0x131 Simpler way

A simpler way to display the exception handler chian is to use.

```c++
0:000> !exchain
0093fd8c: ntdll!_except_handler4+0 (777bad40)
  CRT scope  0, filter: ntdll!__RtlUserThreadStart+3cdb8 (777e4827)
                func:   ntdll!__RtlUserThreadStart+3ce51 (777e48c0)
0093fda4: ntdll!FinalExceptionHandlerPad9+0 (777c8a39)
Invalid exception stack at ffffffff
```

#### 0x132 Manual examination

Address of `(!teb )[ExceptionList]` is 0093fd8c.

```c++
 	0:000> dt 0093fd8c _EXCEPTION_REGISTRATION_RECORD
ConsoleApplication1!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : 0x0093fda4 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x777bad40     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0
DBGHELP: ConsoleApplication1 is not source indexed
0:000> dt 0x0093fda4 _EXCEPTION_REGISTRATION_RECORD
ConsoleApplication1!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x777c8a39     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad9+0
DBGHELP: ConsoleApplication1 is not source indexed
0:000> dt 0xffffffff _EXCEPTION_REGISTRATION_RECORD
ConsoleApplication1!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : ???? 
   +0x004 Handler          : ???? 
Memory read error 00000003
```

## 0x2 Summary

`TEB[0]` is pointer of`TIB`.

| Command                                       | Description                                                  |
| --------------------------------------------- | ------------------------------------------------------------ |
| `!teb`                                        | displays a formatted view of the information in the thread environment block (TEB). <br>Query address of ExceptionList . |
| `dg` fs                                       | shows the segment descriptor for the specified selector.     |
| `!slist` $teb _EXCEPTION_REGISTRATION_RECORDt | Enumerate ExceptionList ;                                    |
| `!exchain`                                    | Display the exception handler chian.                         |

## 0x3 Finally

Maintain a cmdtree script "cmdtree.txt".

![image-20211223112953473](assets/image-20211223112953473.png)
